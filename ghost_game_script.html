<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Spooky Ghost Game (PyScript)</title>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 1rem; }
    #output { white-space: pre-wrap; border: 1px solid #ddd; padding: 1rem; margin-top: 1rem; max-height: 60vh; overflow: auto; background:#fafafa;}
    #status { margin: .5rem 0; color: #b33; }
    .ok { color: #080; }
    .warn { color: #b60; }
  </style>

  <script>
    /**
     * Safe PyScript Loader
     * 
     * This loader handles different PyScript distribution layouts:
     * 1. First tries to load local UMD bundle from ./assets/pyscript/pyscript.js
     * 2. Falls back to CDN ES module with proper type="module" attribute
     * 
     * The key fix: ES modules (core.js) must be loaded with type="module",
     * while UMD bundles (pyscript.js) can be loaded with regular script tags.
     */
    (function () {
      // Local vendor paths (UMD bundle - preferred)
      const localUmdBundle = "./assets/pyscript/pyscript.js";
      const localUmdCss = "./assets/pyscript/pyscript.css";

      // CDN fallback paths (ES modules - require type="module")
      const cdnEsModuleCandidates = [
        {
          css: "https://pyscript.net/releases/2024.1.1/core.css",
          js: "https://pyscript.net/releases/2024.1.1/core.js",
          isModule: true
        },
        {
          css: "https://cdn.jsdelivr.net/npm/@pyscript/core@0.4.21/dist/core.css",
          js: "https://cdn.jsdelivr.net/npm/@pyscript/core@0.4.21/dist/core.js",
          isModule: true
        }
      ];

      function loadCss(url) {
        return new Promise((resolve, reject) => {
          const link = document.createElement("link");
          link.rel = "stylesheet";
          link.href = url;
          link.onload = () => resolve(url);
          link.onerror = () => reject(url);
          document.head.appendChild(link);
        });
      }

      /**
       * Load a JavaScript file with proper module handling
       * @param {string} url - The URL to load
       * @param {boolean} isModule - Whether to load as ES module (type="module")
       */
      function loadJs(url, isModule) {
        return new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.src = url;
          if (isModule) {
            script.type = "module";
          }
          script.defer = true;
          script.onload = () => resolve(url);
          script.onerror = () => reject(url);
          document.head.appendChild(script);
        });
      }

      /**
       * Check if a URL exists via fetch (HTTP 200)
       */
      async function urlExists(url) {
        try {
          const response = await fetch(url, { method: "HEAD" });
          return response.ok;
        } catch (e) {
          return false;
        }
      }

      async function tryLoad() {
        const statusElem = document.createElement("div");
        statusElem.id = "status";
        statusElem.innerText = "Checking for PyScript runtime...";
        document.addEventListener("DOMContentLoaded", () => {
          if (document.body) {
            document.body.insertBefore(statusElem, document.body.firstChild);
          }
        });

        // Step 1: Try local UMD bundle first
        const localBundleExists = await urlExists(localUmdBundle);
        
        if (localBundleExists) {
          console.info("Found local PyScript bundle at", localUmdBundle);
          statusElem.innerText = "Loading local PyScript bundle...";
          
          try {
            // Try loading local CSS (optional)
            const localCssExists = await urlExists(localUmdCss);
            if (localCssExists) {
              await loadCss(localUmdCss);
              console.info("Loaded local PyScript CSS");
            }
            
            // Load local UMD bundle (NOT a module)
            await loadJs(localUmdBundle, false);
            statusElem.innerHTML = "PyScript loaded from: <span class='ok'>local bundle (" + localUmdBundle + ")</span>. Initialising...";
            statusElem.classList.add("ok");
            console.info("Loaded PyScript from local bundle");
            return;
          } catch (e) {
            console.warn("Local bundle load failed:", e);
            statusElem.innerText = "Local bundle failed, trying CDN...";
          }
        } else {
          console.info("Local bundle not found, trying CDN sources...");
          statusElem.innerText = "Trying to load PyScript runtime from CDNs...";
        }

        // Step 2: Fall back to CDN ES modules
        let loaded = false;
        for (const candidate of cdnEsModuleCandidates) {
          try {
            // Load CSS first
            await loadCss(candidate.css);
            console.info("Loaded PyScript CSS from", candidate.css);
            
            // Load JS with proper module type
            await loadJs(candidate.js, candidate.isModule);
            statusElem.innerHTML = "PyScript loaded from: <span class='ok'>" + candidate.js + "</span>" + 
              (candidate.isModule ? " (ES module)" : "") + ". Initialising...";
            statusElem.classList.add("ok");
            console.info("Loaded PyScript JS from", candidate.js, candidate.isModule ? "(ES module)" : "");
            loaded = true;
            break;
          } catch (e) {
            console.warn("CDN load failed:", candidate.js, e);
          }
        }

        if (!loaded) {
          statusElem.innerHTML =
            "<strong>Unable to load PyScript.</strong><br>" +
            "Tried local bundle: <code>" + localUmdBundle + "</code><br>" +
            "Tried CDN sources:<br>" +
            cdnEsModuleCandidates.map(c => "<code>" + c.js + "</code>").join("<br>") +
            "<br><br>Please check your network connection or ensure the local PyScript files are present in assets/pyscript/.";
          statusElem.classList.add("warn");
        }
      }

      tryLoad();
    })();
  </script>
</head>
<body>

<h1>Spooky Ghost Game</h1>
<div id="status">Loading PyScript runtime (this page will update)...</div>

<div id="output"></div>

<py-config>
packages = []
</py-config>

<!-- PyScript game content -->
<py-script>
# Minimal smoke-test print — replace with your full game block if you copied it in
from js import window, document
document.getElementById("output").innerText += "PyScript runtime loaded — executing game code...\n"
# (Place your revised game code here or keep it in this file — once PyScript is loaded it will run.)
</py-script>

</body>
</html>
