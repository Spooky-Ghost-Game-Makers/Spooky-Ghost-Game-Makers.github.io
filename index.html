<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Spooky Ghost Game</title>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 1rem; }
    #status { margin: .5rem 0; color: #b33; }
    #output { white-space: pre-wrap; border: 1px solid #ddd; padding: 1rem; margin-top: 1rem; max-height: 60vh; overflow: auto; background:#fafafa;}
    #controls { margin-top: 0.5rem; }
    button { padding: 0.5rem 1rem; font-size: 1rem; }
    code { background:#f4f4f4; padding:2px 4px; border-radius:3px; }
  </style>

  <script>
    // Loader: attempt to load pyscript.js (bundle) first; otherwise load core.js as module.
    (function () {
      function setStatus(html) {
        var s = document.getElementById("status");
        if (!s) {
          s = document.createElement("div");
          s.id = "status";
          document.body.insertBefore(s, document.body.firstChild);
        }
        s.innerHTML = html;
      }

      async function exists(url) {
        try {
          const res = await fetch(url, { method: "HEAD" });
          return res.ok;
        } catch (e) {
          return false;
        }
      }

      async function tryLoad() {
        setStatus("Checking for local PyScript runtime in <code>./assets/pyscript/</code> ...");
        const cssUrl = "./assets/pyscript/pyscript.css";
        const jsBundleUrl = "./assets/pyscript/pyscript.js";
        const coreModuleUrl = "./assets/pyscript/core.js";

        if (await exists(cssUrl)) {
          const link = document.createElement("link");
          link.rel = "stylesheet";
          link.href = cssUrl;
          document.head.appendChild(link);
          setStatus("Found <code>pyscript.css</code>.");
        }

        if (await exists(jsBundleUrl)) {
          const s = document.createElement("script");
          s.src = jsBundleUrl;
          s.defer = true;
          s.onload = () => setStatus("PyScript loaded from local bundle: <code>" + jsBundleUrl + "</code>");
          s.onerror = () => setStatus("Failed to load local bundle: <code>" + jsBundleUrl + "</code>");
          document.head.appendChild(s);
          return;
        }

        if (await exists(coreModuleUrl)) {
          const s = document.createElement("script");
          s.src = coreModuleUrl;
          s.type = "module"; // IMPORTANT: load as module to avoid 'export' parse error
          s.defer = true;
          s.onload = () => setStatus("PyScript module loaded from: <code>" + coreModuleUrl + "</code>");
          s.onerror = () => setStatus("Failed to load local module: <code>" + coreModuleUrl + "</code>");
          document.head.appendChild(s);
          return;
        }

        setStatus(
          "<strong>PyScript not found in ./assets/pyscript/</strong>.<br>" +
          "Run <code>./vendor_pyscript.sh</code> locally to populate <code>assets/pyscript/</code>, or copy the release <code>dist/</code> contents there.<br>" +
          "Looking for: <br><code>" + jsBundleUrl + "</code><br><code>" + coreModuleUrl + "</code>"
        );
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", tryLoad);
      } else {
        tryLoad();
      }
    })();
  </script>
</head>
<body>

<h1>Spooky Ghost Game</h1>
<div id="status">Loading PyScript runtime (this page will update)...</div>

<div id="controls">
  <button id="startBtn" disabled>Start Game</button>
  <span id="hint" style="margin-left:.5rem;color:#666">Start is enabled once PyScript / Pyodide initializes.</span>
</div>

<div id="output" aria-live="polite"></div>

<py-config>
packages = []
</py-config>

<!--
  <py-script> block: full game at module level.
  Important: DO NOT import create_proxy or attempt to attach Python-created JS callbacks.
  Provide a top-level start_game() that JS can call using whichever runner is available (pyodide.runPython/runPythonAsync or pyscript.runPython).
-->
<py-script>
from js import window, document
import random
import time as time_module
import string

# Output helpers
out_elem = document.getElementById("output")

def write(s=""):
    try:
        out_elem.innerText = out_elem.innerText + str(s) + ("\n" if not str(s).endswith("\n") else "")
        out_elem.scrollTop = out_elem.scrollHeight
    except Exception:
        try:
            # fallback to console if #output not present
            print(s)
        except Exception:
            pass

def print_(*args, sep=" ", end="\n"):
    text = sep.join(str(a) for a in args) + ("" if end == "" else end)
    write(text)

# Provide 'print' name for compatibility with original code
print = print_

def get_input(msg="> "):
    try:
        res = window.prompt(msg)
        if res is None:
            return ""
        return res.strip()
    except Exception:
        return ""

def get_int(msg="> ", default=0):
    while True:
        res = get_input(msg)
        if res == "":
            return default
        try:
            return int(res)
        except Exception:
            print("Please enter a valid number.")

# -------------------------
# Game data and helpers (top-level)
# -------------------------
booleanThing = ["yes", "no"]

def randomPicker9000(randomy):
    global ghost, ghostRoom, weather, cursedItem, ghostName, hidingPlaces
    if randomy == True:
        ghostRoom = random.choice(rooms)
        ghost = random.choice(ghosts)[0]
        weather = random.choice(weathers)
        cursedItem = random.choice(cursedItems)
        ghostName = random.choice(firstNames) + " " + random.choice(lastNames)
        hidingPlaces = {
            "Entrance Hallway": [random.choice(booleanThing), False],
            "Kid's Bedroom": [random.choice(booleanThing), False],
            "Garage": [random.choice(booleanThing), False],
            "Dining Room": [random.choice(booleanThing), False],
            "Kitchen": [random.choice(booleanThing), False],
            "Basement": [random.choice(booleanThing), False],
            "Living Room": [random.choice(booleanThing), False],
            "Master Bedroom": [random.choice(booleanThing), False],
            "Bathroom": [random.choice(booleanThing), False],
            "En Suite": [random.choice(booleanThing), False]
        }
    elif randomy == "name":
        return ghostName
    elif randomy == "room":
        return ghostRoom
    elif randomy == "ghost":
        return ghost
    elif randomy == "weather":
        return weather
    elif randomy == "cursedItem":
        return cursedItem

roomSizes = {
    "Entrance Hallway": [3, 15],
    "Kid's Bedroom": [8,8],
    "Garage": [11, 9],
    "Dining Room": [8, 10],
    "Kitchen": [8,10],
    "Basement": [10, 15],
    "Living Room": [8,8],
    "Master Bedroom": [8,9],
    "Bathroom": [5,5],
    "En Suite": [5,5]
}

rooms = ["Entrance Hallway", "Kid's Bedroom", "Garage", "Dining Room", "Kitchen", "Basement", "Living Room",
         "Master Bedroom", "Bathroom", "En Suite", "Truck"]

hidingPlaces = {}

weathers = ["Clear", "Rain", "Snow", "Sunny"]

cursedItems = ["Monkey Paw", "Music Box", "Voodoo Doll", "Magic Mirror", "Summoning Circle", "Tarot Cards",
               "Ouija Board"]

firstNames = ["Adam", "Alex", "Andrew", "Benjamin", "Christopher", "Daniel", "David", "Duck", "Edward", "Eric", "George",
              "Jack", "James", "John", "Joseph", "Kevin", "Mark", "Michael", "Paul", "Peter", "Robert", "Ronald",
              "Steven", "Tom", "William", "Alice", "Annabelle", "Barbara", "Betty", "Carol", "Donna", "Elizabeth",
              "Helen", "Jennifer", "Karen", "Linda", "Lisa", "Margaret", "Mary", "Nancy", "Patricia", "Ruth", "Sandra",
              "Sarah", "Susan", "Caleb"]

lastNames = ["Alexander", "Anderson", "Bailey", "Baker", "Barber", "Barton", "Bellfield", "Birch", "Bishop", "Bowen",
             "Brock", "Brooks", "Brown", "Buckley", "Carey", "Carter", "Clark", "Clarke", "Cordero", "Corrigan",
             "Davis", "Dexter", "Dixon", "Doe", "Douglas", "Dyer", "Elliott", "Emmett", "Everly", "Gacy", "Garcia",
             "Gayton", "Halstead", "Hans", "Harris", "Hill", "Holland", "Holmes", "Huntley", "Jackson", "Johnson",
             "Jones", "Kemper", "Knight", "Kraft", "Kray", "Lancaster", "Lavender", "Lee", "Lewis", "Manson", "Marsh",
             "Martin", "Martinez", "Maudsley", "Miller", "Mills", "Moore", "Myers", "Nilsen", "Norris", "Pettit",
             "Phillips", "Price", "Ramirez", "Rhoades", "Roberts", "Robinson", "Rook", "Roswell", "Schelin", "Shawcross",
             "Sherman", "Shipman", "Skinner", "Smith", "Stevens", "Straffen", "Sweeney", "Taylor", "Thomas", "Thompson",
             "Todd", "Walker", "Watts", "West", "White", "Williams", "Wilson", "Winter", "Wright", "Young"]

ghosts = [["Spirit", "EMF5", "Spirit Box", "Ghost Writing"],
          ["Poltergeist", "UV", "Spirit Box", "Ghost Writing"],
          ["The Mimic", "Ghost Orbs", "Spirit Box", "Freezing Temps", "UV"],
          ["Thaye", "DOTS", "Ghost Orbs", "Ghost Writing"],
          ["Oni", "DOTS", "EMF5", "Freezing Temps"],
          ["Obake", "UV", "Ghost Orbs", "EMF5"],
          ["Demon", "Ghost Writing", "Freezing Temps", "UV"],
          ["Phantom", "Spirit Box", "DOTS", "UV"],
          ["Goryo", "DOTS", "UV", "EMF5"],
          ["Banshee", "Ghost Orbs", "UV", "DOTS"],
          ["Wraith", "DOTS", "EMF5", "Spirit Box"],
          ["Revenant", "Freezing Temps", "Ghost Writing", "Ghost Orbs"],
          ["Hantu", "Freezing Temps", "UV", "Ghost Orbs"],
          ["Mare", "Ghost Orbs", "Spirit Box", "Ghost Writing"],
          ["Jinn", "UV", "Freezing Temps", "EMF5"],
          ["Onryo", "Spirit Box", "Ghost Orbs", "Freezing Temps"],
          ["Yokai", "Ghost Orbs", "DOTS", "Spirit Box"],
          ["Yurei", "Ghost Orbs", "DOTS", "Freezing Temps"],
          ["Deogen", "Ghost Writing", "Spirit Box", "DOTS"],
          ["Raiju", "DOTS", "Ghost Orbs", "EMF5"],
          ["Moroi", "Spirit Box", "Freezing Temps", "Ghost Writing"],
          ["Myling", "UV", "EMF5", "Ghost Writing"],
          ["The Twins", "EMF5", "Spirit Box", "Freezing Temps"],
          ["Shade", "EMF5", "Freezing Temps", "Ghost Writing"]]

equipment = [["Thermometer", "", "Freezing Temps"],
             ["EMF Reader", 3, "EMF5"],
             ["Video Camera", "", "Ghost Orbs"],
             ["Spirit Box", 3, "Spirit Box"],
             ["Ultraviolet Light", 2, "UV"],
             ["Ghost Writing Book", 3, "Ghost Writing"],
             ["DOTS Projector", 5, "DOTS"]]

roomDrawings = {"Entrance Hallway": [[]], "Kid's Bedroom": [[]], "Garage": [[]], "Dining Room": [[]], "Kitchen": [[]], "Basement": [[]], "Living Room": [[]],
         "Master Bedroom": [[]], "Bathroom": [[]], "En Suite": [[]]}

# Module-level state
ghost = ""
ghostRoom = ""
weather = ""
cursedItem = ""
ghostName = ""
ghostLocationRoom = ""
location = "Truck"
gameTime = 0
events = 0
playerInventory = ["", "", ""]
ouijaEvents = 0
musicEvents = 0
mirrorEvents = 0
huntActive = False
isHiding = False
truckStuff = []
huntTurnsRemaining = 0
huntGhostType = None
huntIsCursed = False

# -------------------------
# Game functions (kept from original source)
# -------------------------
def cursedItemSpawn(cursedItemParam):
    if cursedItemParam == "Monkey Paw":
        return "Dining Room"
    elif cursedItemParam == "Tarot Cards":
        return "Living Room"
    elif cursedItemParam == "Magic Mirror":
        return "Entrance Hallway"
    elif cursedItemParam == "Music Box":
        return "Kid's Bedroom"
    elif cursedItemParam == "Voodoo Doll":
        return "Garage"
    elif cursedItemParam == "Ouija Board":
        return "Basement"
    elif cursedItemParam == "Summoning Circle":
        return "Kitchen"

def temperatures():
    if randomPicker9000("weather") == "Clear":
        tempWeatherEffect = 0
    elif randomPicker9000("weather") == "Rain":
        tempWeatherEffect = 3
    elif randomPicker9000("weather") == "Snow":
        tempWeatherEffect = 7
    elif randomPicker9000("weather") == "Sunny":
        tempWeatherEffect = -2
    if ghostLocationRoom == location:
        tempWeatherEffect = 13
    for row in ghosts:
        if randomPicker9000("ghost") in row:
            if "Freezing Temps" in row:
                tempWeatherEffect = 20
    averageTemp = 17 - tempWeatherEffect
    tempFlux = random.randrange(-2,2)
    return (averageTemp + tempFlux)

def thermometer():
    print("The temperature it reads is: ", temperatures())
    regular()

def UV():
    obj = random.choice(["window", "door"])
    if ghostLocationRoom == location:
        UVChance = random.randint(0,2)
        if UVChance == 0:
            for row in ghosts:
                if randomPicker9000("ghost") in row:
                    if "UV" in row:
                        print("You look around the room with a UV light, and you see a spooky looking handprint on a", obj + ".")
                    else:
                        print("You look around the room with a UV light, but you find nothing.")
                    break
            else:
                print("You look around the room with a UV light, but you find nothing.")
        else:
            print("You look around the room with the UV light, but find nothing.")
    else:
        print("You look around the room with a UV light, but you find nothing.")
    regular()

def videoCamera():
    if ghostLocationRoom == location:
        orbsChance = random.randint(0,1)
        if orbsChance == 0:
            for row in ghosts:
                if randomPicker9000("ghost") in row:
                    if "Ghost Orbs" in row:
                        print("You look around the room with the camera, and you see a small glowing sphere dancing around the room.")
                    else:
                        print("You look around the room with the camera, but you find nothing.")
                    break
            else:
                print("You look around the room with the camera, but you find nothing.")
        else:
            print("You look around the room with the camera, but you find nothing.")
    else:
        print("You look around the room with the camera, but you find nothing.")
    regular()

def roomDraw(width, height, draw=True, roomParam=None):
    if roomParam is None:
        roomParam = location
    if not roomDrawings.get(roomParam) or not roomDrawings[roomParam] or not roomDrawings[roomParam][0]:
        roomDrawings[roomParam] = [[" " for _ in range(width)] for _ in range(height)]
    if draw:
        print("   " + " ".join(str(i) for i in range(1, width + 1)))
        for i, row in enumerate(roomDrawings[roomParam]):
            label = string.ascii_uppercase[i]
            print(f"{label}: " + " ".join(row))

def coordinates(width, height):
    letterToNumber = {letter: i + 1 for i, letter in enumerate(string.ascii_uppercase)}
    while True:
        coords = get_input("Enter coordinates of placement (e.g., A5) > ").strip()
        if len(coords) < 2:
            print("Invalid format. Example: A5")
            continue
        rowLetter = coords[0].upper()
        columnPart = coords[1:]
        if rowLetter not in letterToNumber:
            print("Invalid row letter. Must be A–Z.")
            continue
        row = letterToNumber[rowLetter]
        if not columnPart.isdigit():
            print("Column must be a number.")
            continue
        col = int(columnPart)
        if row < 1 or row > height:
            print(f"Row out of range. Must be A to {string.ascii_uppercase[height-1]}.")
            continue
        if col < 1 or col > width:
            print(f"Column out of range. Must be 1 to {width}.")
            continue
        return [row - 1, col - 1]

def itemLetter(item):
    match item:
        case "Ghost Writing Book":
            return "B"
        case "DOTS Projector":
            return "D"
        case "EMF Reader":
            return "E"
        case _:
            return "I"

def itemPlace():
    roomParam = location
    items = inventoryCheck("Raw List")
    print("What item do you want to place down?")
    for i in range(3):
        if items[i] != "":
            print(f"Slot {i+1} - {items[i]}")
    choice = get_input("> ").strip()
    if choice not in ["1", "2", "3"]:
        print("Invalid slot.")
        return regular()
    choice_idx = int(choice) - 1
    if items[choice_idx] == "":
        print("Slot is empty.")
        return regular()
    itemToPlace = items[choice_idx]
    if itemToPlace not in ["EMF Reader", "Ghost Writing Book", "DOTS Projector"]:
        print("You cannot place this item.")
        return regular()
    height, width = roomSizes[roomParam]
    roomDraw(width, height)
    coords = coordinates(width, height)
    letter = itemLetter(itemToPlace)
    try:
        roomDrawings[roomParam][coords[0]][coords[1]] = letter
    except IndexError:
        print("Placement failed due to grid bounds error.")
        return regular()
    playerInventory[choice_idx] = ""
    tick(True)
    print(f"Placed {itemToPlace} at {string.ascii_uppercase[coords[0]]}{coords[1]+1}")
    roomDraw(width, height)
    return regular()

def die():
    print("You feel a hand lying on your shoulder, you quickly turn around to find a blank room.")
    time_module.sleep(1.5)
    print("You suddenly feel a sharp pain in your neck, and you start choking. The spooky ghost got you. Game Over.")
    raise SystemExit("Game Over")

def hunt(ghostType=None, cursed=False):
    global ghostLocationRoom, huntActive, huntTurnsRemaining, huntGhostType, huntIsCursed
    if ghostType is None:
        ghostType = ghost
    huntActive = True
    huntGhostType = ghostType
    huntIsCursed = cursed
    huntTurnsRemaining = 10 if cursed else 5
    print("All the lights flicker and all of the equipment in the room begins to malfunction in a flurry of beeps and boops. A hunt has begun.")
    regular()

def processHunt():
    global ghostLocationRoom, huntActive, huntTurnsRemaining, isHiding, huntGhostType
    if not huntActive:
        return
    if huntGhostType != "Deogen":
        ghostLocationRoom = random.choice(rooms)
    else:
        ghostLocationRoom = location
    if ghostLocationRoom == location:
        chanceToDie = random.randint(0, 2)
        if chanceToDie == 0:
            if isHiding == False:
                die()
            elif isHiding == True:
                print("The ghost walks past you, it didn't see you hide.")
    huntTurnsRemaining -= 1
    if huntTurnsRemaining <= 0:
        print("The lights go back to normal, the hunt is over.")
        ghostLocationRoom = randomPicker9000("room")
        huntActive = False

def inventoryCheck(check):
    if check == "List":
        print("You have: ", playerInventory[0], ", ", playerInventory[1], ",", playerInventory[2], ".")
    if check == "Raw List":
        returnList = [playerInventory[0], playerInventory[1], playerInventory[2]]
        return returnList
    if check == "Space":
        for idx, item in enumerate(playerInventory):
            if item == "":
                return idx
        return None

def checkForHidingSpot():
    global isHiding
    if hidingPlaces.get(location) and "yes" in hidingPlaces[location]:
        if hidingPlaces[location][1] == True:
            choice = get_input("There is a hiding spot in this room, would you like to hide? (Y/N)>")
            if choice.lower() == "y":
                print("You are now hiding.")
                isHiding = True
                return True
            else:
                print("You don't hide. You note the hiding spot for later.")
                return False
    elif hidingPlaces.get(location) and "no" in hidingPlaces[location]:
        print("You have not found a hiding spot or the lack there of in this room yet. Inspect it first.")
    return False

def huntChance():
    if ghost == "Demon":
        chance = random.randint(0, 3)
    elif ghost == "Thaye":
        if sanityCheck(False) < 75:
            chance = random.randint(0, 4)
        else:
            return False
    elif ghost == "Raiju":
        if sanityCheck(False) < 65:
            chance = random.randint(0, 4)
        else:
            return False
    elif ghost == "Shade":
        if sanityCheck(False) < 35:
            chance = random.randint(0, 6)
        else:
            return False
    elif ghost == "Deogen":
        if sanityCheck(False) < 40:
            chance = random.randint(0, 4)
        else:
            return False
    elif ghost == "Banshee":
        if sanityCheck(False) < 55:
            chance = random.randint(0, 4)
        else:
            return False
    elif ghost == "Onryo":
        if sanityCheck(False) < 60:
            chance = random.randint(0, 4)
        else:
            return False
    else:
        if sanityCheck(False) < 50:
            chance = random.randint(0, 4)
        else:
            return False
    if chance == 0:
        return True
    return False

def tick(doTick):
    global gameTime
    if doTick == True:
        gameTime += 1
        if huntActive == True:
            processHunt()
        if huntChance() == True and not huntActive:
            hunt()
    return gameTime

def ghostAge(ghostType, check):
    global age, ghost
    if check == True:
        age = random.randint(40, 90)
        if ghostType == "Thaye":
            age = age + tick(False)
    return age

def sanityCheck(event):
    global ouijaEvents, musicEvents, mirrorEvents
    if event == False:
        sanity = 100 - (tick(False) + (events * 5) + (ouijaEvents * 15) + (musicEvents * 20) + (mirrorEvents * 25))
        if sanity < 0:
            sanity = 0
        return sanity
    elif event == "Ouija":
        ouijaEvents += 1
    elif event == "Music Box":
        musicEvents += 1
    elif event == "Magic Mirror":
        mirrorEvents += 1

def ouija():
    global ouijaEvents
    sanityCheck("Ouija")
    tick(True)
    question = get_input("What do you want to say to the ghost? >")
    response = ("The ghost says: " + str(ouijaBoard(question)))
    print(response)
    choice1 = get_input("Do you want to ask another question? Y/N >")
    if choice1.lower() == "y":
        ouija()
    else:
        return

def ouijaBoard(question):
    ghostLoc = randomPicker9000("room")
    name = randomPicker9000("name")
    q = question.lower()
    if "old" in q:
        return ghostAge(ghost, False)
    elif "age" in q:
        return ghostAge(ghost, False)
    elif "name" in q:
        return name
    elif "room" in q:
        return ghostLoc
    elif "where" in q:
        return ghostLoc
    elif "crazy" in q:
        return sanityCheck(False)
    elif "sane" in q:
        return sanityCheck(False)
    elif "sanity" in q:
        return sanityCheck(False)
    elif "seek" in q:
        hunt(randomPicker9000("ghost"), True)
        return "The ghost has been summoned to seek."
    else:
        return "The ghost is silent."

def musicBox():
    global musicEvents
    sanityCheck("Music Box")
    tick(True)
    print("The song is soothing, and somewhat creepy. Your hand is forced to turn its coil.")
    if location == ghostLocationRoom:
        if ghost != "The Twins":
            boxVoice = random.randint(0, 2)
            if boxVoice == 0:
                print("You hear what sounds like a man's voice close by. The lid to the music box slams shut and the manifestation of a ghost starts to form before you.")
                hunt()
            elif boxVoice == 1:
                print("You hear a woman's voice as a cold hand slams the box out of your hand. (Top Tip!: Run)")
                hunt()
            else:
                print("You hear very menacing quacking as an evil spirit holding a duck appears before you.")
        else:
            print("You hear two voices echo in the room you stand. A ghost approaches you with murderous intent")
            hunt()
    else:
        print("You hear the distant echo of a strange voice")

def voodoo():
    tick(True)
    print("You push in a pin on the doll.")
    chance = random.randint(0, 2)
    if chance == 0:
        hunt(ghost, False)

def magicMirror():
    sanityCheck("Magic Mirror")
    tick(True)
    print("You gaze into the mirror with a duck sticker on its back and it shows you the ghosts surroundings")
    match randomPicker9000("room"):
        case "Living Room":
            print("The room contains sofas, TVs and a nice looking fireplace.")
        case "Garage":
            print("The room contains a lot of tools and a random Volkswagen Beetle")
        case "Bathroom":
            print("The room contains a collection on highly specific rubber duckies and a variety of soaps. It also has a bath.")
        case "Kid's Bedroom":
            print("The room contains a rubber ducky on the shelf and a lot of other collections like yugioh cards. (It also has child sized clothes and a child sized bed).")
        case "Dining Room":
            print("The room contains a large table decorated with plates and an empty vase.")
        case "Kitchen":
            print("The room contains a variety of cooking appliances and many sharp knife shaped objects.")
        case "Basement":
            print("The room features a lot of loose wires and a variety of boxes containing stuff.")
        case "Master Bedroom":
            print("The room features a giant bed and a small entrance to a small bathroom. It is a massive bedroom.")
        case "En suite":
            print("The room is small, yet it is significantly cleaner than its larger counterpart")
        case "Entrance Hallway":
            print("The room is just a hallway. It has a lot of doors that lead to other rooms. Its literally where you found this mirror.")

# ... The rest of the original game functions remain the same as in your source code
# For brevity in this message, assume the full function bodies from your repo are present here
# (When you paste, keep the existing functions exactly as in your source.)
#
# Initialize helpers and state in start_game:
def start_game():
    global ghost, ghostRoom, weather, cursedItem, ghostName, hidingPlaces
    global ghostLocationRoom, location, gameTime, events, playerInventory
    global ouijaEvents, musicEvents, mirrorEvents, huntActive, isHiding, truckStuff
    global huntTurnsRemaining, huntGhostType, huntIsCursed

    # Initialize random values and state
    randomPicker9000(True)
    ghostLocationRoom = randomPicker9000("room")
    location = "Truck"
    gameTime = 0
    events = 0
    playerInventory = ["", "", ""]
    ouijaEvents = 0
    musicEvents = 0
    mirrorEvents = 0
    huntActive = False
    isHiding = False
    truckStuff = []
    huntTurnsRemaining = 0
    huntGhostType = None
    huntIsCursed = False

    # Ghost age init
    ghostAge(randomPicker9000("ghost"), True)

    # Welcome and start main loop
    print("PyScript runtime loaded — executing game code...")
    print("Welcome to Spooky Ghost Game!")
    print("Your goal is to identify the ghost and survive.")
    regular(True)

</py-script>

<!--
  Robust runner detection & Start button wiring.
  This replaces Python-side create_proxy usage and handles pyodide/pyscript API differences safely.
-->
<script>
(function() {
  function findRunner() {
    // Prefer pyodide.runPython/runPythonAsync
    if (window.pyodide) {
      if (typeof window.pyodide.runPython === 'function') {
        return { type: 'sync', call: (code) => window.pyodide.runPython(code) };
      }
      if (typeof window.pyodide.runPythonAsync === 'function') {
        return { type: 'async', call: (code) => window.pyodide.runPythonAsync(code) };
      }
    }

    // Fallback to pyscript namespace (some PyScript builds)
    if (window.pyscript) {
      if (typeof window.pyscript.runPython === 'function') {
        return { type: 'sync', call: (code) => window.pyscript.runPython(code) };
      }
      if (typeof window.pyscript.runPythonAsync === 'function') {
        return { type: 'async', call: (code) => window.pyscript.runPythonAsync(code) };
      }
      if (window.pyscript.interpreter && typeof window.pyscript.interpreter.run === 'function') {
        return { type: 'sync', call: (code) => window.pyscript.interpreter.run(code) };
      }
    }

    return null;
  }

  const interval = setInterval(async () => {
    const runner = findRunner();
    const btn = document.getElementById('startBtn');

    if (btn && runner) {
      btn.removeAttribute('disabled');

      // Remove any previous handlers to avoid double-binding
      btn.onclick = null;

      btn.addEventListener('click', async () => {
        try {
          if (runner.type === 'sync') {
            runner.call('start_game()');
          } else {
            // async runner returns a Promise
            await runner.call('start_game()');
          }
        } catch (err) {
          console.error('Error starting game via runner:', err);
          alert('Failed to start game — see console for details.');
        }
      });

      clearInterval(interval);
    }

    // keep polling up to timeout
  }, 250);

  // Safety: stop polling after 10s
  setTimeout(() => clearInterval(interval), 10000);
})();
</script>

</body>
</html>
